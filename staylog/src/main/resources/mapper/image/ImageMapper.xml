<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
								 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.staylog.staylog.domain.image.mapper.ImageMapper">

<!-- 이미지 업로드 관련 SQL 쿼리 -->
	<insert id="insertImage" parameterType="imageDto">
		<selectKey keyProperty="imageId" resultType="long" order="BEFORE">
		    SELECT seq_image_id.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO image_file (
		    image_id,
			image_type, target_type, target_id,
			saved_url, original_name, file_size,
			mime_type, display_order, upload_date
		)
		VALUES (
		    #{imageId},
			#{imageType}, #{targetType}, #{targetId},
			#{savedUrl}, #{originalName}, #{fileSize},
			#{mimeType}, #{displayOrder}, SYSDATE
		)
	</insert>

	<!-- 행을 비관적 잠금으로 조회 -->
	<select id="selectForUpdate" resultType="long" parameterType="imageDto">
		SELECT next_display_order
		FROM image_target_counter
		WHERE target_type = #{targetType} AND target_id = #{targetId}
		FOR UPDATE
	</select>
	
	<!-- 카운터 값을 업데이트 -->
	<update id="updateCounter" parameterType="imageDto">
		UPDATE image_target_counter
		SET next_display_order = #{counterValue}
		WHERE target_type = #{targetType} AND target_id = #{targetId}
	</update>
	
	<!-- 새로운 카운터 레코드를 생성 -->
	<insert id="createCounter" parameterType="imageDto">
		INSERT INTO image_target_counter(target_type, target_id, next_display_order)
		VALUES (#{targetType}, #{targetId}, #{counterValue})
	</insert>


<!-- 이미지 불러오기 관련 SQL 쿼리 -->
	<!-- target 정보로 이미지 목록 불러오기 -->
	<select id="selectImagesByTarget" resultType="imageDto">
		SELECT
			image_id, image_type, target_type, target_id,
			saved_url, original_name, file_size,
			mime_type, display_order, upload_date
		FROM image_file
		WHERE target_type = #{targetType} AND target_id = #{targetId}
		ORDER BY display_order ASC
	</select>
	
	<!-- imageId로 이미지 정보 불러오기 -->
	<select id="selectImageById" parameterType="long" resultType="imageDto">
    SELECT
        image_id, image_type, target_type, target_id,
        saved_url, original_name, file_size,
        mime_type, display_order, upload_date
    FROM image_file
    WHERE image_id = #{imageId}
	</select>
	
	
<!-- 이미지 삭제 관련 SQL 쿼리 -->	
	<!-- 특정 이미지를 imageId로 삭제 -->
	<delete id="deleteImage" parameterType="long">
		DELETE FROM image_file WHERE image_id = #{imageId}		
	</delete>

	<!-- 삭제된 이미지보다 displayOrder가 뒤에 있는 이미지들의 순서를 1씩 앞당김 -->
	<update id="updateDisplayOrderAfterDelete" parameterType="imageDto">
		UPDATE image_file
    SET display_order = display_order - 1
    WHERE target_type = #{targetType} AND target_id = #{targetId} AND display_order > #{deletedDisplayOrder}
	</update>

	<!-- 지정된 target 의 카운터를 1 감소 -->
	<update id="decrementCounter" parameterType="imageDto">
		UPDATE image_target_counter
		SET next_display_order = next_display_order - 1
		WHERE target_type = #{targetType} AND target_id = #{targetId}
	</update>
	
	<!-- target에 속한 모든 이미지 일괄 삭제 -->
	<delete id="deleteImagesByTarget" parameterType="imageDto">
		DELETE FROM image_file WHERE target_type = #{targetType} AND target_id = #{targetId}
	</delete>
	
	<!-- target에 속한 카운터 레코드를 삭제 -->
	<delete id="deleteCounterByTarget" parameterType="imageDto">
		DELETE FROM image_target_counter WHERE target_type = #{targetType} AND target_id = #{targetId}
	</delete>
	
	<!-- 특정 이미지의 displayOrder만 업데이트 -->
	<update id="updateImageDisplayOrder" parameterType="imageDto">
	  UPDATE image_file
	  SET display_order = #{displayOrder}
	  WHERE image_id = #{imageId}
	</update>
  
	<!-- 카운터 값을 특정 값으로 설정 -->
	<update id="setCounterValue" parameterType="imageDto">
		UPDATE image_target_counter
		SET next_display_order = #{counterValue}
		WHERE target_type = #{targetType} AND target_id = #{targetId}
	</update>
	
	<!-- 여러 targetId에 해당하는 이미지 목록 불러오기 (N+1 문제 해결용) -->
	<select id="selectImagesByTargetIds" resultType="imageDto">
		SELECT
			image_id, image_type, target_type, target_id,
			saved_url, original_name, file_size,
			mime_type, display_order, upload_date
		FROM image_file
		WHERE target_type = #{targetType}
		AND target_id IN
		<foreach item="item" index="index" collection="targetIds" open="(" separator="," close=")">
			#{item}
		</foreach>
		ORDER BY target_id, display_order ASC
	</select>
	
	<!-- 대표이미지 추출 쿼리 -->
    <!-- ImageDto 결과 매핑 -->
    <resultMap id="imageDtoResultMap" type="com.staylog.staylog.domain.image.dto.ImageDto">
        <id property="imageId" column="image_id"/>
        <result property="targetType" column="target_type"/>
        <result property="targetId" column="target_id"/>
        <result property="imageUrl" column="saved_url"/> <!-- saved_url을 imageUrl로 매핑 -->
        <result property="originalName" column="original_name"/>
        <result property="uploadDate" column="upload_date"/>
        <result property="displayOrder" column="display_order"/>
    </resultMap>

    <!-- 여러 targetId에 대한 대표 이미지 조회 (displayOrder 우선) -->
    <select id="selectFirstImageByTargetIds" resultMap="imageDtoResultMap">
	    SELECT
	      i.image_id, i.target_type, i.target_id, i.saved_url,
	      i.original_name, i.upload_date, i.display_order
	    FROM
        image_file i
	    INNER JOIN (
        SELECT
          t.target_id, MIN(t.image_id) AS representative_image_id
        FROM
          image_file t
        INNER JOIN (
          SELECT
            target_id, MIN(display_order) AS min_display_order
          FROM
            image_file
          WHERE
            target_type = #{targetType}
            AND target_id IN
            <foreach item="targetId" collection="targetIds" open="(" separator="," close=")">
              #{targetId}
            </foreach>
          GROUP BY
            target_id
        ) min_orders
        ON
          t.target_id = min_orders.target_id
          AND t.display_order = min_orders.min_display_order
        WHERE
          t.target_type = #{targetType}
        GROUP BY
        	t.target_id
	    ) representative_images
	    ON
        i.image_id = representative_images.representative_image_id
	    WHERE
        i.target_type = #{targetType}
    </select>

</mapper>