<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.staylog.staylog.domain.search.mapper.SearchMapper">

    <resultMap id="AccomWithImagesMap" type="com.staylog.staylog.domain.search.dto.response.AccomListResponse">
        <id property="accommodationId" column="ACCOMMODATION_ID"/>
        <result property="accommodationName" column="ACCOMMODATION_NAME"/>
        <result property="regionName" column="REGION_NAME"/>
        <result property="minCapacity" column="MIN_CAPACITY"/>
        <result property="maxCapacity" column="MAX_CAPACITY"/>
        <result property="basePrice" column="BASE_PRICE"/>
        <result property="reservationCount" column="RES_COUNT"/>
        <result property="totalCapacity" column="TOTAL_CAPACITY"/>
        <!-- 이미지 임시 비활성화 -->
        <!--
        <collection property="mainImg" ofType="String">
            <result column="IMG_URL"/>
        </collection>
        -->
    </resultMap>

    <!-- 1단계: 예약 가능한 숙소 ID 추출 -->
    <select id="getAvailableAccomIds" resultType="long">
        SELECT DISTINCT R.ACCOMMODATION_ID
        FROM ROOM R
        WHERE R.DELETED_YN = 'N'
        <if test="people != null">
            AND R.TOTAL_CAPACITY >= #{people}
        </if>
        <if test="checkIn != null and checkOut != null">
            AND NOT EXISTS (
                SELECT 1
                FROM RESERVATION X
                WHERE X.ROOM_ID = R.ROOM_ID
                  AND X.STATUS IN ('CONFIRMED','PENDING')
                  AND X.CHECK_IN <![CDATA[<]]> #{checkOut}
                  AND X.CHECK_OUT > #{checkIn}
            )
        </if>
    </select>

    <!-- 2단계: 숙소 기본 정보 + 객실 집계 (예약 수 제외) -->
    <select id="getAccomListBasic" resultMap="AccomWithImagesMap">
        SELECT * FROM (
            SELECT
                A.ACCOMMODATION_ID,
                A.NAME AS ACCOMMODATION_NAME,
                C.CODE_NAME AS REGION_NAME,
                2 AS MIN_CAPACITY,
                MAX(R.TOTAL_CAPACITY) AS MAX_CAPACITY,
                SUM(R.TOTAL_CAPACITY) AS TOTAL_CAPACITY,
                MIN(R.PRICE) AS BASE_PRICE,
                0 AS RES_COUNT,
                A.CREATED_AT,
                ROW_NUMBER() OVER (
                    <choose>
                        <when test="request.order == 'lowPrice'">
                            ORDER BY MIN(R.PRICE) ASC, A.ACCOMMODATION_ID ASC
                        </when>
                        <when test="request.order == 'highPrice'">
                            ORDER BY MIN(R.PRICE) DESC, A.ACCOMMODATION_ID ASC
                        </when>
                        <when test="request.order == 'new'">
                            ORDER BY A.CREATED_AT DESC, A.ACCOMMODATION_ID ASC
                        </when>
                        <when test="request.order == 'popular'">
                            ORDER BY A.ACCOMMODATION_ID ASC
                        </when>
                        <otherwise>
                            ORDER BY A.NAME ASC, A.ACCOMMODATION_ID ASC
                        </otherwise>
                    </choose>
                ) AS RN
            FROM ACCOMMODATION A
            JOIN COMMON_CODE C ON A.REGION_CODE = C.CODE_ID AND C.USE_YN = 'Y'
            JOIN ROOM R ON A.ACCOMMODATION_ID = R.ACCOMMODATION_ID AND R.DELETED_YN = 'N'
            <where>
                A.DELETED_YN = 'N'
                <if test="availableAccomIds != null and !availableAccomIds.isEmpty()">
                    AND A.ACCOMMODATION_ID IN
                    <foreach item="id" collection="availableAccomIds" open="(" separator="," close=")">
                        #{id}
                    </foreach>
                </if>
                <if test="request.regionCodes != null and !request.regionCodes.isEmpty()">
                    AND A.REGION_CODE IN
                    <foreach item="code" collection="request.regionCodes" open="(" separator="," close=")">
                        #{code}
                    </foreach>
                </if>
                <!-- 무한 스크롤: lastAccomId 이후 데이터만 조회 -->
                <if test="request.lastAccomId != null">
                    AND A.ACCOMMODATION_ID > #{request.lastAccomId}
                </if>
            </where>
            GROUP BY A.ACCOMMODATION_ID, A.NAME, C.CODE_NAME, A.CREATED_AT
        )
        WHERE RN BETWEEN 1 AND 20
    </select>

    <!-- 3단계: 예약 수만 조회 (popular 정렬 시만 호출) -->

    <select id="getReservationCounts" resultType="map">
        SELECT
            R.ACCOMMODATION_ID as accommodationId,
            NVL(COUNT(DISTINCT RS.BOOKING_ID), 0) AS reservationCount
        FROM ROOM R
        LEFT JOIN RESERVATION RS
          ON RS.ROOM_ID = R.ROOM_ID
         AND RS.STATUS IN ('CONFIRMED', 'PENDING')
        WHERE R.DELETED_YN = 'N'
          AND R.ACCOMMODATION_ID IN
          <foreach item="id" collection="accommodationIds" open="(" separator="," close=")">
              #{id}
          </foreach>
        GROUP BY R.ACCOMMODATION_ID
    </select>

</mapper>
