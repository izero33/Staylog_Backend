<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.staylog.staylog.domain.admin.board.mapper.AdminBoardMapper">

	<!-- 게시글 목록 조회 -->
	<select id="selectBoardList" parameterType="BoardSearchRequest" resultType="BoardDto">
		SELECT *
	    FROM (
		    SELECT t.*, ROWNUM AS rn
		    FROM (
				SELECT
				    b.board_id,
				    b.accommodation_id,
				    a.name AS accommodationName,
				    b.user_id,
				    u.nickname AS userNickName,
				    b.title,
				    <!-- 리뷰 게시글만 사용 -->
				    b.rating,
				    b.likes_count AS likes,
				    b.views_count,
				    TO_CHAR(b.created_at, 'YYYY-MM-DD"T"HH24:MI:SS') AS createdAt,
				    b.deleted
			    FROM board b
			    LEFT JOIN accommodation a ON a.accommodation_id = b.accommodation_id
			    LEFT JOIN users u ON u.user_id = b.user_id
			    <where>
			    	b.board_type = #{boardType}
					<if test="keyword != null and keyword != ''">
					    <choose>
					        <!-- 숙소명으로 검색 -->
					        <when test="searchType == 'accommodationName'">
					            AND a.name LIKE '%' || #{keyword} || '%'
					        </when>
					        <!-- 닉네임으로 검색 -->
					        <when test="searchType == 'userNickName'">
					            AND u.nickname LIKE '%' || #{keyword} || '%'
					        </when>
					    </choose>
					</if>
		        	<if test="deleted != null and deleted != ''">
			           AND b.deleted = #{deleted}
			        </if>
		        </where>
				ORDER BY b.deleted ASC,
			        <choose>
			            <!-- 작성일 정렬 -->
			            <when test="sortBy == 'createdAt'">
			                b.created_at
			            </when>
			            <!-- 조회수 정렬 -->
			            <when test="sortBy == 'viewsCount'">
			                b.views_count
			            </when>
			            <!-- 별점 정렬 (리뷰만) -->
			            <when test="sortBy == 'rating'">
			                b.rating
			            </when>
			            <!-- 좋아요 정렬 -->
			            <when test="sortBy == 'likes'">
			                b.likes_count
			            </when>
			            <!-- 기본: 작성일 -->
			            <otherwise>
			                b.created_at
			            </otherwise>
			        </choose>
			        <choose>
			            <when test="sortOrder == 'ASC'">
			                ASC
			            </when>
			            <otherwise>
			                DESC
			            </otherwise>
			        </choose>
			) t
		)
		WHERE rn BETWEEN #{startRow} AND #{endRow}
	</select>
	
	<!-- 전체 게시글 수 조회 -->
	<select id="countBoardList" parameterType="BoardSearchRequest" resultType="int">
	    SELECT COUNT(*)
	    FROM board b
	    LEFT JOIN accommodation a ON a.accommodation_id = b.accommodation_id
	    LEFT JOIN users u ON u.user_id = b.user_id
	    <where>
	        b.board_type = #{boardType}
	        <if test="keyword != null and keyword != ''">
	            <choose>
	                <!-- 숙소명으로 검색 -->
	                <when test="searchType == 'accommodationName'">
	                    AND a.name LIKE '%' || #{keyword} || '%'
	                </when>
	                <!-- 닉네임으로 검색 -->
	                <when test="searchType == 'userNickName'">
	                    AND u.nickname LIKE '%' || #{keyword} || '%'
	                </when>
	            </choose>
	        </if>
	        <if test="deleted != null and deleted != ''">
	            AND b.deleted = #{deleted}
	        </if>
	    </where>
	</select>

	<!-- 게시글 상세 조회-->
	<select id="selectBoardDetail" parameterType="long" resultType="BoardDto">
		SELECT
		    b.board_id,
		    b.accommodation_id,
		    a.name AS accommodationName,
		    b.booking_id,
		    b.user_id,
		    u.nickname AS userNickName,
		    b.region_code,
		    cr.code_name AS regionName,
		    b.title,
		    b.content,
		    b.rating,
		    b.likes_count AS likes,
		    b.views_count,
		    TO_CHAR(b.created_at, 'YYYY-MM-DD"T"HH24:MI:SS') AS createdAt,
		    TO_CHAR(b.updated_at, 'YYYY-MM-DD"T"HH24:MI:SS') AS updatedAt,
		    b.deleted
	    FROM board b
	    LEFT JOIN common_code cr ON cr.code_id = b.region_code AND cr.use_yn = 'Y'
	    LEFT JOIN accommodation a ON a.accommodation_id = b.accommodation_id
	    LEFT JOIN users u ON u.user_id = b.user_id
	    WHERE b.board_id = #{boardId}
	</select>

	<!-- 게시글 논리 삭제/복원(상태전환) -->
	<update id="updateBoardStatus" parameterType="BoardStatusRequest">
	    UPDATE board
	    SET deleted = #{deleted},
	        updated_at = SYSTIMESTAMP
	    WHERE board_id = #{boardId}
	</update>

</mapper>