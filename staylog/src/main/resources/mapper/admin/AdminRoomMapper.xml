<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.staylog.staylog.domain.admin.room.mapper.AdminRoomMapper">

	<!-- 숙소별 객실 목록 조회 -->
	<select id="selectRoomListByAccommodation" parameterType="AdminRoomSearchRequest" resultType="AdminRoomDetailResponse">
		SELECT *
	    FROM (
		    SELECT t.*, ROWNUM AS rn
			FROM (
			    SELECT
				    	r.accommodation_id,
				    	a.name AS accommodationName,
			        r.room_id,
			        r.name,
			        r.rm_type,
			        ct.code_name AS typeName,
			        r.price,
			        r.max_adult,
			        r.deleted_yn,
			        TO_CHAR(r.created_at, 'YYYY-MM-DD"T"HH24:MI:SS') AS createdAt
			    FROM room r
			    LEFT JOIN accommodation a ON a.accommodation_id = r.accommodation_id
			    LEFT JOIN common_code ct ON ct.code_id = r.rm_type AND ct.use_yn = 'Y'
			    <where>
			    		r.accommodation_id = #{accommodationId}
					<if test="rmType != null and rmType != ''">
						AND r.rm_type = #{rmType}
					</if>
					<if test="keyword != null and keyword != ''">
						AND r.name LIKE '%' || #{keyword} || '%'
					</if>
					<if test="deletedYn != null and deletedYn != ''">
						AND r.deleted_yn = #{deletedYn}
					</if>
		        </where>
			    ORDER BY r.deleted_yn ASC, r.created_at DESC
			) t
		)
		WHERE rn BETWEEN #{startRow} AND #{endRow}
	</select>
	
	<!-- 전체 게시글 수 조회 -->
	<select id="countRoomList" parameterType="AdminRoomSearchRequest" resultType="int">
	    SELECT COUNT(*)
	    FROM room r
	    <where>
	    		r.accommodation_id = #{accommodationId}
            <if test="rmType != null and rmType != ''">
            		AND r.rm_type = #{rmType}
        		</if>
        		<if test="deletedYn != null and deletedYn != ''">
	           	AND r.deleted_yn = #{deletedYn}
	        </if>
			<if test="keyword != null and keyword != ''">
	            AND r.name LIKE '%' || #{keyword} || '%'
	        </if>
        </where>
	</select>

	<!-- 객실 상세 조회 -->
	<select id="selectRoomDetail" parameterType="long" resultType="AdminRoomDetailResponse">
	    SELECT
		    	r.accommodation_id,
		    	a.name AS accommodationName,
	        r.room_id,
	        r.name,
	        r.rm_type,
	        ct.code_name AS typeName,
	        r.price,
	        r.max_adult,
	        r.max_children,
	        r.max_infant,
	        r.area,
	        r.deleted_yn,
	        r.single_bed,
	        r.double_bed,
	        r.queen_bed,
	        r.king_bed,
	        r.description,
			TO_CHAR(a.check_in_time, 'HH24:MI') AS checkInTime,
			TO_CHAR(a.check_out_time, 'HH24:MI') AS checkOutTime,
	        TO_CHAR(r.created_at, 'YYYY-MM-DD"T"HH24:MI:SS') AS createdAt,
	        TO_CHAR(r.updated_at, 'YYYY-MM-DD"T"HH24:MI:SS') AS updatedAt
	    FROM room r 
	    LEFT JOIN common_code ct ON ct.code_id = r.rm_type AND ct.use_yn = 'Y'
	    LEFT JOIN accommodation a ON a.accommodation_id = r.accommodation_id
	    WHERE r.room_id = #{roomId}
	</select>

	<!-- 객실 수정 -->
	<update id="updateRoom" parameterType="AdminRoomRequest">
		UPDATE room
	    SET name = #{name},
	        rm_type = #{rmType},
	        price = #{price},
	        max_adult = #{maxAdult},
	        max_children = #{maxChildren},
	        max_infant = #{maxInfant},
	        area = #{area},
	        single_bed = #{singleBed},
	        double_bed = #{doubleBed},
	        queen_bed = #{queenBed},
	        king_bed = #{kingBed},
	        updated_at = SYSTIMESTAMP,
	        description = #{description}
	    WHERE room_id = #{roomId}
	</update>
	
	<!-- 객실 논리 삭제/복원(상태전환) -->
	<update id="updateRoomStatus" parameterType="RoomUpdateStatusRequest">
	    UPDATE room
	    SET deleted_yn = #{deletedYn},
	        updated_at = SYSTIMESTAMP
	    WHERE room_id = #{roomId}
	</update>

	<!-- 객실 추가 -->
	<insert id="insertRoom" parameterType="AdminRoomRequest">
	    INSERT INTO room (
	        room_id, accommodation_id, name, rm_type,
	        price, max_adult, max_children, max_infant, area,
	        single_bed, double_bed, queen_bed, king_bed, description,
	        created_at
	    ) VALUES (
	        #{roomId}, #{accommodationId}, #{name}, #{rmType},
	        #{price}, #{maxAdult}, #{maxChildren}, #{maxInfant}, #{area},
	        #{singleBed}, #{doubleBed}, #{queenBed}, #{kingBed}, #{description},
	        SYSTIMESTAMP
	    )
	</insert>
</mapper>
