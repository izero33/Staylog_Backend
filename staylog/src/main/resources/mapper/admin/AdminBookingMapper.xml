<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.staylog.staylog.domain.admin.booking.mapper.AdminBookingMapper">

    <!-- 예약 목록 조회 -->
    <select id="findBookings"
            parameterType="com.staylog.staylog.domain.admin.booking.dto.request.AdminBookingListRequest"
            resultType="com.staylog.staylog.domain.admin.booking.dto.AdminBookingDto">
        SELECT *
        FROM (
        SELECT
        r.booking_id,
        r.booking_num,
        r.guest_name,
        u.name AS user_name,
        a.name AS accommodation_name,
        rm.room_name,
        r.check_in,
        r.check_out,
        r.adults,
        r.children,
        r.infants,
        r.total_guest_count,
        r.amount,
        r.status,
        c.code_name_kr AS status_name,
        c.attr1 AS status_color,
        r.created_at,
        ROW_NUMBER() OVER (ORDER BY r.created_at DESC) AS rn
        FROM reservation r
        LEFT JOIN users u ON u.user_id = r.user_id
        LEFT JOIN room rm ON rm.room_id = r.room_id
        LEFT JOIN accommodation a ON a.accommodation_id = rm.accommodation_id
        LEFT JOIN common_code c ON c.code_id = r.status
        <where>
            <if test="status != null and status != ''">
                AND r.status = #{status}
            </if>
            <if test="guestName != null and guestName != ''">
                AND r.guest_name LIKE CONCAT('%', #{guestName}, '%')
            </if>
            <if test="userName != null and userName != ''">
                AND u.name LIKE CONCAT('%', #{userName}, '%')
            </if>
        </where>
        )
        WHERE rn BETWEEN ( (#{pageNum}-1) * #{pageSize} + 1 )
        AND (#{pageNum} * #{pageSize})
    </select>

    <!-- 예약 상세 조회 -->
    <select id="getBookingDetail"
            parameterType="long"
            resultType="com.staylog.staylog.domain.admin.booking.dto.AdminBookingDto">
        SELECT
            r.booking_id,
            r.booking_num,
            r.guest_name,
            u.name AS user_name,
            u.email AS user_email,
            a.name AS accommodation_name,
            rm.room_name,
            r.check_in,
            r.check_out,
            r.adults,
            r.children,
            r.infants,
            r.total_guest_count,
            r.amount,
            r.status,
            c.code_name_kr AS status_name,
            c.attr1 AS status_color,
            r.created_at,
            r.updated_at
        FROM reservation r
                 LEFT JOIN users u ON u.user_id = r.user_id
                 LEFT JOIN room rm ON rm.room_id = r.room_id
                 LEFT JOIN accommodation a ON a.accommodation_id = rm.accommodation_id
                 LEFT JOIN common_code c ON c.code_id = r.status
        WHERE r.booking_id = #{bookingId}
    </select>

    <!-- 예약 상태 변경 -->
    <update id="updateBookingStatus">
        UPDATE reservation
        SET status = #{status},
            updated_at = SYSTIMESTAMP
        WHERE booking_id = #{bookingId}
    </update>

    <!-- 전체 건수 조회 -->
    <select id="countBookings" resultType="int">
        SELECT COUNT(1)
        FROM reservation r
        LEFT JOIN users u ON u.user_id = r.user_id
        <where>
            <if test="status != null and status != ''">
                AND r.status = #{status}
            </if>
            <if test="guestName != null and guestName != ''">
                AND r.guest_name LIKE CONCAT('%', #{guestName}, '%')
            </if>
            <if test="userName != null and userName != ''">
                AND u.name LIKE CONCAT('%', #{userName}, '%')
            </if>
        </where>
    </select>

</mapper>
