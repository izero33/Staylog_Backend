<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.staylog.staylog.domain.admin.reservation.mapper.AdminReservationMapper">

    <!-- 예약 목록 조회 -->
    <select id="findReservations"
            parameterType="com.staylog.staylog.domain.admin.reservation.dto.request.AdminReservationListRequest"
            resultType="com.staylog.staylog.domain.admin.reservation.dto.AdminReservationDto">
        SELECT *
        FROM (
        SELECT
        r.booking_id,
        r.booking_num,
        r.guest_name,
        u.name AS user_name,
        a.name AS accommodation_name,
        rm.room_name,
        r.check_in,
        r.check_out,
        r.adults,
        r.children,
        r.infants,
        r.total_guest_count,
        r.amount,
        r.status,
        c.code_name_kr AS status_name,
        c.attr1 AS status_color,
        r.created_at,
        ROW_NUMBER() OVER (ORDER BY r.created_at DESC) AS rn
        FROM reservation r
        LEFT JOIN users u         ON u.user_id = r.user_id
        LEFT JOIN room rm         ON rm.room_id = r.room_id
        LEFT JOIN accommodation a ON a.accommodation_id = rm.accommodation_id
        LEFT JOIN common_code c   ON c.code_id = r.status
        <where>
            <!-- 상태 -->
            <if test="status != null and status != ''">
                AND r.status = #{status}
            </if>

            <!-- 게스트명 / 유저명 -->
            <if test="guestName != null and guestName != ''">
                AND r.guest_name LIKE '%' || #{guestName} || '%'
            </if>
            <if test="userName != null and userName != ''">
                AND u.name LIKE '%' || #{userName} || '%'
            </if>

            <!-- 선택: 사용자 / 숙소 / 날짜 범위 필터 -->
            <if test="userId != null">
                AND r.user_id = #{userId}
            </if>
            <if test="stayId != null">
                AND a.accommodation_id = #{stayId}
            </if>
            <if test="startDate != null and startDate != ''">
                AND r.created_at &gt;= TO_TIMESTAMP(#{startDate}, 'YYYY-MM-DD HH24:MI:SS')
            </if>
            <if test="endDate != null and endDate != ''">
                AND r.created_at &lt;  TO_TIMESTAMP(#{endDate}, 'YYYY-MM-DD HH24:MI:SS')
            </if>

            <!-- 상태 코드 그룹 -->
            <if test="statusGroupId != null and statusGroupId != ''">
                AND c.parent_id = #{statusGroupId}
            </if>
        </where>
        ) t
        WHERE t.rn BETWEEN ( (#{pageNum} - 1) * #{pageSize} + 1 )
        AND (  #{pageNum} * #{pageSize} )
    </select>

    <!-- 예약 상세 조회 -->
    <select id="getReservationDetail"
            parameterType="java.lang.Long"
            resultType="com.staylog.staylog.domain.admin.reservation.dto.AdminReservationDto">
        SELECT
        r.booking_id,
        r.booking_num,
        r.guest_name,
        u.name  AS user_name,
        u.email AS user_email,
        a.name  AS accommodation_name,
        rm.room_name,
        r.check_in,
        r.check_out,
        r.adults,
        r.children,
        r.infants,
        r.total_guest_count,
        r.amount,
        r.status,
        c.code_name_kr AS status_name,
        c.attr1        AS status_color,
        r.created_at,
        r.updated_at
        FROM reservation r
        LEFT JOIN users u         ON u.user_id = r.user_id
        LEFT JOIN room rm         ON rm.room_id = r.room_id
        LEFT JOIN accommodation a ON a.accommodation_id = rm.accommodation_id
        LEFT JOIN common_code c   ON c.parent_id = r.status
        WHERE r.booking_id = #{bookingId}
    </select>

    <!-- 예약 상태 변경 -->
    <update id="updateBReservationStatus" parameterType="map">
        UPDATE reservation
        SET status = #{status},
        updated_at = SYSTIMESTAMP
        WHERE booking_id = #{bookingId}
    </update>

    <!-- 전체 건수 조회 (목록과 동일한 필터를 유지) -->
    <select id="countReservations"
            parameterType="com.staylog.staylog.domain.admin.reservation.dto.request.AdminReservationListRequest"
            resultType="int">
        SELECT COUNT(1)
        FROM reservation r
        LEFT JOIN users u         ON u.user_id = r.user_id
        LEFT JOIN room rm         ON rm.room_id = r.room_id
        LEFT JOIN accommodation a ON a.accommodation_id = rm.accommodation_id
        LEFT JOIN common_code c   ON c.code_id = r.status
        <where>
            <if test="status != null and status != ''">
                AND r.status = #{status}
            </if>
            <if test="guestName != null and guestName != ''">
                AND r.guest_name LIKE '%' || #{guestName} || '%'
            </if>
            <if test="userName != null and userName != ''">
                AND u.name LIKE '%' || #{userName} || '%'
            </if>
            <if test="userId != null">
                AND r.user_id = #{userId}
            </if>
            <if test="stayId != null">
                AND a.accommodation_id = #{stayId}
            </if>
            <if test="startDate != null and startDate != ''">
                AND r.created_at &gt;= TO_TIMESTAMP(#{startDate}, 'YYYY-MM-DD HH24:MI:SS')
            </if>
            <if test="endDate != null and endDate != ''">
                AND r.created_at &lt;  TO_TIMESTAMP(#{endDate}, 'YYYY-MM-DD HH24:MI:SS')
            </if>
            <if test="statusGroupId != null and statusGroupId != ''">
                AND c.group_id = #{statusGroupId}
            </if>
        </where>
    </select>

</mapper>
