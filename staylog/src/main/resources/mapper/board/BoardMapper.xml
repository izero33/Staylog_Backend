<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.staylog.staylog.domain.board.mapper.BoardMapper">


    <!--  해당 카테고리 전체 게시글 수  -->
    <select id="countByBoardType" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM board
        WHERE board_type = #{boardType}
            AND deleted = 'N'
    </select>
    
    <!-- 해당 카테고리 게시판 목록 조회 (삭제된 게시글 제외) -->
    <select id="getByBoardType" parameterType="BoardRequest" resultType="BoardResponse">
        SELECT board_id, accommodation_id, booking_id user_id, region_code, board_type,
            title, likes_count, rating, views_count, created_at, updated_at, deleted
        FROM board
        WHERE board_type = #{boardType}
            AND deleted = 'N'
        ORDER BY created_at DESC
    </select>


    <!-- 해당 카테고리 게시글 상세 조회 -->
    <select id="getByBoardId" parameterType="string" resultType="BoardDto">
        SELECT board_id, accommodation_id, booking_id user_id, region_code, board_type,
        title, likes_count, rating, views_count, created_at, updated_at, deleted
        FROM board
        WHERE board_id = #{boardId}
        ORDER BY created_at DESC
    </select>
        
    <!-- 게시글 수정 -->
    <update id="update" parameterType="BoardRequest">
        UPDATE board
        SET title = #{title},
            content = #{content},
            rating = #{rating},
            updated_at = SYSDATE
        WHERE board_id = #{boardId}

    </update>
    
    <!-- 게시글 삭제 (논리 삭제) -->
    <update id="delete" parameterType="long">
        UPDATE board
        SET deleted = 'Y',
            updated_at = SYSDATE
        WHERE board_id = #{boardId}
    </update>
    
    <!-- 게시글 등록 -->
    <insert id="insert" parameterType="boardRequest">
        <selectKey keyProperty="board_id" resultType="long" order="BEFORE">
            SELECT seq_board_id.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO board
        (board_id, accommodation_id, booking_id, user_id, region_code, board_type,
            title, content, rating)
        VALUES (
            #{boardId}, #{accommodationId}, #{bookingId}, #{userId}, #{regionCode}, #{boardType},
            #{title}, #{content}, #{rating})

    </insert>



<!-- 시퀀스 생성 board

   CREATE SEQUENCE seq_board_id
        START WITH 1
        INCREMENT BY 1;

-->


    <!-- 테이블 생성 board

    CREATE TABLE board (
        board_id           NUMBER PRIMARY KEY,
        accommodation_id   NUMBER NOT NULL,
        booking_id         NUMBER UNIQUE,
        user_id            NUMBER NOT NULL,

        region_code        VARCHAR2(20) NOT NULL,
        board_type         VARCHAR2(20) NOT NULL,

        title              VARCHAR2(255) NOT NULL,
        content            CLOB NOT NULL,
        likes_count        NUMBER DEFAULT 0,
        rating             NUMBER CHECK (rating BETWEEN 1 AND 5),
        views_count        NUMBER DEFAULT 0,

        created_at         TIMESTAMP DEFAULT SYSTIMESTAMP,
        updated_at         TIMESTAMP DEFAULT SYSTIMESTAMP,
        deleted            CHAR(1) DEFAULT 'N' CHECK (deleted IN ('Y','N'))
    );

    -->




</mapper>
