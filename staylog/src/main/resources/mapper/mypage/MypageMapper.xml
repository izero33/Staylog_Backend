<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.staylog.staylog.domain.mypage.mapper.MypageMapper">

    <!-- 1. 회원 정보 조회 -->
    <select id="selectMemberInfo"
            parameterType="long"
            resultType="MemberInfoDto">
        SELECT
            user_id, login_id, email, role, name, nickname, phone,
            gender, birth_date, profile_image, created_at, updated_at
        FROM users
        WHERE user_id = #{userId}
    </select>

    <!-- 2. 회원 정보 수정 -->
    <update id="updateMemberInfo"
            parameterType="MemberInfoDto">
        UPDATE users
        <set>
        	<!-- (모두 입력했을 때만 변경) -->
        	<if test="name != null and name != ''">name = #{name},</if>            
	        <if test="password != null and password != ''">password = #{password},</if>            
	        <if test="nickname != null and nickname != ''">nickname = #{nickname},</if>            
	        <if test="email != null and email != ''">email = #{email},</if>            
	        <if test="phone != null and phone != ''">phone = #{phone},</if>            
	        <if test="gender != null and gender != ''">gender = #{gender},</if>
	        <if test="birthDate != null and birthDate != ''">
            	birth_date = TO_DATE(REGEXP_SUBSTR(#{birthDate}, '^[0-9]{4}-[0-9]{2}-[0-9]{2}'), 'YYYY-MM-DD'),
	        </if>
	        <!-- 프로필 이미지 -->
			<if test="profileImage != null and profileImage != ''">
            	profile_image = #{profileImage, jdbcType=VARCHAR},
       		</if>
		    updated_at = SYSDATE
		</set>
		WHERE user_id = #{userId}
    </update>



    <!-- 3. 예약 내역 (status = upcoming/completed/canceled) -->
    <select id="selectBookings"
            resultType="BookingInfoResponse">
        SELECT
            r.booking_id AS bookingId,
            r.booking_num AS bookingNum,
            a.name AS accommodationName,
            rm.name AS roomName,
            r.check_in  AS checkIn,
            r.check_out AS checkOut,
            r.status    AS status,
            r.created_at AS createdAt
        FROM reservation r
        	JOIN room rm ON r.room_id = rm.room_id
	        JOIN accommodation a ON rm.accommodation_id = a.accommodation_id
        WHERE r.user_id = #{userId}
        <!-- status 필터는 문자열(upcoming/completed/canceled)로 받되 DB값은 CONFIRMED, CANCELED라서 choose 로 매핑 -->
        <choose>
        	<!-- 다가올 예약-->
            <when test="status == 'upcoming'">
                AND r.status = 'CONFIRMED'
                AND r.check_in &gt; SYSDATE
            </when>
            <!-- 이용 완료 -->
            <when test="status == 'completed'">
                AND r.status = 'CONFIRMED'
                AND r.check_out &lt; SYSDATE
            </when>
            <!-- 취소/환불 -->
            <when test="status == 'canceled'">
                AND r.status IN ('CANCELED', 'REFUNDED')
            </when>
            <!-- status 안보내면 전체 -->
        </choose>
        ORDER BY r.check_in DESC
    </select>

    <!-- 5. 리뷰 내역 -->
    <select id="selectReviews"
            resultType="ReviewInfoResponse">
        <choose>
            <!-- 작성 가능한 리뷰 -->
            <when test="type == 'available'">
                SELECT
                    b.booking_id AS bookingId,
                    a.accommodation_name AS accommodationName,
                    b.check_in  AS checkIn,
                    b.check_out AS checkOut
                FROM booking b
                JOIN accommodation a ON a.accommodation_id = b.accommodation_id
                WHERE b.user_id = #{userId}
                  AND b.status = 'CONFIRMED'
                  AND b.check_out &lt; SYSDATE
                  AND NOT EXISTS (
                      SELECT 1 FROM review r WHERE r.booking_id = b.booking_id
                  )
                ORDER BY b.check_out DESC
            </when>

            <!-- 내가 쓴 리뷰 -->
            <otherwise>
                SELECT
                    r.review_id AS reviewId,
                    a.accommodation_name AS accommodationName,
                    r.content   AS content,
                    r.rating    AS rating,
                    r.created_at AS createdAt
                FROM review r
                JOIN booking b ON r.booking_id = b.booking_id
                JOIN accommodation a ON a.accommodation_id = b.accommodation_id
                WHERE b.user_id = #{userId}
                ORDER BY r.created_at DESC
            </otherwise>
        </choose>
    </select>

</mapper>

